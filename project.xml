<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>const int SPEED = 1;    // slots/time
const int N_SLOTS = 104;
const int N_MAIN_BRANCH = 93;
const int START_BRANCH_SLOT = 66;
const int END_BRANCH_SLOT = 88;
const int N_STATIONS = 6;
const int N_IN_SENSORS = 6;
const int N_OUT_SENSORS = 5;

// TODO
typedef int[0, N_STATIONS - 1] station_id_t;

chan        stationInput[N_STATIONS], stationOutput[N_STATIONS];
// END TODO

broadcast chan initialize, move, receive_all;
urgent chan go[N_SLOTS+N_STATIONS], stop[N_SLOTS+N_STATIONS], switch_branch, ready_to_receive;

bool sequence[N_SLOTS + N_STATIONS]; // true: slot, false: station
bool system_state[N_SLOTS + N_STATIONS];

void init_system() {
    for(i : int[0, N_SLOTS + N_STATIONS - 1])
        sequence[i] = true;
    sequence[1] = false;
    sequence[19] = false;
    sequence[40] = false;
    sequence[83] = false;
    sequence[95] = false;
    sequence[104] = false;


    for(i : int[0, N_SLOTS + N_STATIONS - 1])
        if(i &gt;= 3 and i &lt;= 14)
            system_state[i] = true;
        else
            system_state[i] = false;
}

bool init_disks(int id) {
    if(id &gt;= 3 and id &lt;= 14)
        return true;
    return false;
}</declaration>
	<template>
		<name x="5" y="5">conveyor_belt_slot</name>
		<parameter>const int id</parameter>
		<declaration>int next_slot, prev_slot;
bool occupied;

int get_next() {
    if(id == N_MAIN_BRANCH - 1)
        return 0;
    if(id == N_SLOTS + N_STATIONS - 1)
        return END_BRANCH_SLOT;
    return id + 1;
}

int get_prev() {
    if(id == 0)
        return N_MAIN_BRANCH - 1;
    if(id == N_MAIN_BRANCH)
        return START_BRANCH_SLOT;
    return id - 1;
}

void initialize_slot() {
    occupied = init_disks(id);
    next_slot = get_next();
    prev_slot = get_prev();
}

void switch_branch() {
    if(next_slot == id + 1)
        next_slot = N_MAIN_BRANCH;
    else
        next_slot = id + 1;
}</declaration>
		<location id="id0" x="-187" y="-561">
		</location>
		<location id="id1" x="-187" y="-416">
			<name x="-178" y="-442">Free_to_Move</name>
		</location>
		<location id="id2" x="-459" y="-280">
			<name x="-442" y="-289">Stopped</name>
		</location>
		<location id="id3" x="178" y="-416">
			<committed/>
		</location>
		<location id="id4" x="-459" y="-110">
			<committed/>
		</location>
		<location id="id5" x="-459" y="-416">
			<committed/>
		</location>
		<location id="id6" x="178" y="-110">
			<committed/>
		</location>
		<location id="id7" x="-8" y="-110">
			<name x="-51" y="-144">Wait_to_Receive</name>
		</location>
		<location id="id8" x="-187" y="-110">
			<committed/>
		</location>
		<location id="id9" x="-510" y="-476">
			<committed/>
		</location>
		<init ref="id0"/>
		<transition id="id10">
			<source ref="id9"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="-416" y="-501">go[prev_slot]!</label>
			<nail x="-229" y="-476"/>
		</transition>
		<transition id="id11">
			<source ref="id2"/>
			<target ref="id9"/>
			<label kind="synchronisation" x="-561" y="-382">go[id]?</label>
			<nail x="-510" y="-331"/>
		</transition>
		<transition id="id12">
			<source ref="id8"/>
			<target ref="id1"/>
			<label kind="guard" x="-399" y="-238">system_state[id] = false</label>
			<label kind="assignment" x="-357" y="-221">occupied = false</label>
			<nail x="-246" y="-161"/>
			<nail x="-246" y="-348"/>
		</transition>
		<transition id="id13">
			<source ref="id8"/>
			<target ref="id1"/>
			<label kind="guard" x="-178" y="-238">system_state[id] == true</label>
			<label kind="assignment" x="-178" y="-221">occupied = true</label>
		</transition>
		<transition id="id14">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="synchronisation" x="-119" y="-110">receive_all?</label>
		</transition>
		<transition id="id15">
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="42" y="-110">ready_to_receive!</label>
		</transition>
		<transition id="id16">
			<source ref="id1"/>
			<target ref="id1"/>
			<label kind="guard" x="-127" y="-348">id == START_BRANCH_SLOT</label>
			<label kind="synchronisation" x="-127" y="-331">switch_branch?</label>
			<label kind="assignment" x="-127" y="-314">switch_branch()</label>
			<nail x="-102" y="-365"/>
			<nail x="-153" y="-323"/>
		</transition>
		<transition id="id17">
			<source ref="id3"/>
			<target ref="id6"/>
			<label kind="guard" x="93" y="-289">occupied == false</label>
			<label kind="assignment" x="93" y="-272">system_state[next_slot] = false</label>
			<nail x="85" y="-365"/>
			<nail x="85" y="-161"/>
		</transition>
		<transition id="id18">
			<source ref="id3"/>
			<target ref="id6"/>
			<label kind="guard" x="331" y="-289">occupied == true</label>
			<label kind="assignment" x="331" y="-272">system_state[next_slot] = true</label>
			<nail x="323" y="-365"/>
			<nail x="323" y="-161"/>
		</transition>
		<transition id="id19">
			<source ref="id5"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="-450" y="-348">stop[prev_slot]!</label>
		</transition>
		<transition id="id20">
			<source ref="id1"/>
			<target ref="id5"/>
			<label kind="guard" x="-357" y="-416">occupied == true</label>
			<label kind="synchronisation" x="-357" y="-399">stop[id]?</label>
		</transition>
		<transition id="id21">
			<source ref="id4"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="-620" y="-204">stop[prev_slot]!</label>
			<nail x="-518" y="-110"/>
			<nail x="-518" y="-280"/>
		</transition>
		<transition id="id22">
			<source ref="id2"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="-450" y="-212">move?</label>
			<nail x="-459" y="-178"/>
		</transition>
		<transition id="id23">
			<source ref="id1"/>
			<target ref="id3"/>
			<label kind="synchronisation" x="-34" y="-442">move?</label>
			<nail x="-59" y="-416"/>
		</transition>
		<transition id="id24">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="-178" y="-518">initialize?</label>
			<label kind="assignment" x="-178" y="-501">initialize_slot()</label>
		</transition>
	</template>
	<template>
		<name>conveyor_belt_motor</name>
		<declaration>clock x;</declaration>
		<location id="id25" x="-790" y="-484">
		</location>
		<location id="id26" x="-790" y="-348">
			<label kind="invariant" x="-773" y="-357">x &lt;= SPEED</label>
		</location>
		<init ref="id25"/>
		<transition id="id27">
			<source ref="id26"/>
			<target ref="id26"/>
			<label kind="guard" x="-807" y="-280">x &gt;= SPEED</label>
			<label kind="synchronisation" x="-807" y="-263">move!</label>
			<label kind="assignment" x="-807" y="-246">x = 0</label>
			<nail x="-807" y="-280"/>
			<nail x="-765" y="-280"/>
		</transition>
		<transition id="id28">
			<source ref="id25"/>
			<target ref="id26"/>
			<label kind="synchronisation" x="-782" y="-433">initialize?</label>
			<label kind="assignment" x="-782" y="-416">x = 0, init_system()</label>
		</transition>
	</template>
	<template>
		<name>conveyor_belt_handler</name>
		<declaration>int c;</declaration>
		<location id="id29" x="-399" y="-297">
		</location>
		<location id="id30" x="-399" y="-161">
		</location>
		<init ref="id29"/>
		<transition id="id31">
			<source ref="id30"/>
			<target ref="id29"/>
			<label kind="guard" x="-552" y="-263">c == N_SLOTS</label>
			<label kind="synchronisation" x="-527" y="-246">receive_all!</label>
			<label kind="assignment" x="-493" y="-229">c = 0</label>
			<nail x="-450" y="-195"/>
			<nail x="-450" y="-272"/>
			<nail x="-416" y="-289"/>
		</transition>
		<transition id="id32">
			<source ref="id30"/>
			<target ref="id30"/>
			<label kind="synchronisation" x="-450" y="-85">ready_to_receive?</label>
			<label kind="assignment" x="-450" y="-68">c++</label>
			<nail x="-365" y="-85"/>
			<nail x="-425" y="-85"/>
		</transition>
		<transition id="id33">
			<source ref="id29"/>
			<target ref="id30"/>
			<label kind="synchronisation" x="-391" y="-246">ready_to_receive?</label>
			<label kind="assignment" x="-391" y="-229">c = 1</label>
		</transition>
	</template>
	<template>
		<name>in_sensor</name>
		<parameter>const int id, const int on_slot, const int guarded_station</parameter>
		<location id="id34" x="-535" y="-1105">
		</location>
		<location id="id35" x="-535" y="-986">
			<name x="-603" y="-1011">Unlocked</name>
		</location>
		<location id="id36" x="-866" y="-986">
			<committed/>
		</location>
		<location id="id37" x="-535" y="-773">
			<name x="-560" y="-807">Locked</name>
		</location>
		<location id="id38" x="-229" y="-986">
			<committed/>
		</location>
		<init ref="id34"/>
		<transition id="id39">
			<source ref="id37"/>
			<target ref="id37"/>
			<label kind="guard" x="-628" y="-688">system_state[guarded_station] == true</label>
			<label kind="synchronisation" x="-560" y="-671">receive_all?</label>
			<nail x="-526" y="-765"/>
			<nail x="-492" y="-688"/>
			<nail x="-569" y="-688"/>
		</transition>
		<transition id="id40">
			<source ref="id35"/>
			<target ref="id35"/>
			<label kind="guard" x="-628" y="-909">system_state[guarded_station] == false</label>
			<label kind="synchronisation" x="-560" y="-892">receive_all?</label>
			<nail x="-526" y="-977"/>
			<nail x="-492" y="-909"/>
			<nail x="-569" y="-909"/>
		</transition>
		<transition id="id41">
			<source ref="id38"/>
			<target ref="id35"/>
			<label kind="synchronisation" x="-407" y="-986">go[on_slot]!</label>
		</transition>
		<transition id="id42">
			<source ref="id37"/>
			<target ref="id38"/>
			<label kind="guard" x="-492" y="-773">system_state[guarded_station] == false</label>
			<label kind="synchronisation" x="-492" y="-756">receive_all?</label>
			<nail x="-229" y="-773"/>
		</transition>
		<transition id="id43">
			<source ref="id36"/>
			<target ref="id37"/>
			<label kind="synchronisation" x="-773" y="-773">stop[on_slot]!</label>
			<nail x="-866" y="-773"/>
		</transition>
		<transition id="id44">
			<source ref="id35"/>
			<target ref="id36"/>
			<label kind="guard" x="-815" y="-986">system_state[guarded_station] == true</label>
			<label kind="synchronisation" x="-815" y="-969">receive_all?</label>
		</transition>
		<transition id="id45">
			<source ref="id34"/>
			<target ref="id35"/>
			<label kind="synchronisation" x="-526" y="-1063">initialize?</label>
		</transition>
	</template>
	<template>
		<name>out_sensor</name>
		<parameter>const int id, const int on_slot, const int guarded_station, const int related_in_sensor</parameter>
		<declaration>bool full_queue() {
    bool check = true;

    for(i : int[on_slot, related_in_sensor])
        if(system_state[i] == false)
            check = false;

    return check;
}</declaration>
		<location id="id46" x="42" y="111">
			<name x="17" y="77">Locked</name>
		</location>
		<location id="id47" x="42" y="-102">
			<name x="-26" y="-127">Unlocked</name>
		</location>
		<location id="id48" x="348" y="-102">
			<committed/>
		</location>
		<location id="id49" x="-289" y="-102">
			<committed/>
		</location>
		<location id="id50" x="42" y="-221">
		</location>
		<init ref="id50"/>
		<transition id="id51">
			<source ref="id46"/>
			<target ref="id46"/>
			<label kind="guard" x="-8" y="195">full_queue() == true</label>
			<label kind="synchronisation" x="17" y="213">receive_all?</label>
			<nail x="51" y="119"/>
			<nail x="85" y="196"/>
			<nail x="8" y="196"/>
		</transition>
		<transition id="id52">
			<source ref="id47"/>
			<target ref="id47"/>
			<label kind="guard" x="-8" y="-25">full_queue() == false</label>
			<label kind="synchronisation" x="17" y="-8">receive_all?</label>
			<nail x="51" y="-93"/>
			<nail x="85" y="-25"/>
			<nail x="8" y="-25"/>
		</transition>
		<transition id="id53">
			<source ref="id48"/>
			<target ref="id47"/>
			<label kind="synchronisation" x="170" y="-102">go[guarded_station]!</label>
		</transition>
		<transition id="id54">
			<source ref="id46"/>
			<target ref="id48"/>
			<label kind="guard" x="127" y="110">full_queue() == false</label>
			<label kind="synchronisation" x="127" y="127">receive_all?</label>
			<nail x="348" y="111"/>
		</transition>
		<transition id="id55">
			<source ref="id49"/>
			<target ref="id46"/>
			<label kind="synchronisation" x="-196" y="111">stop[guarded_station]!</label>
			<nail x="-289" y="111"/>
		</transition>
		<transition id="id56">
			<source ref="id47"/>
			<target ref="id49"/>
			<label kind="guard" x="-238" y="-102">full_queue() == true</label>
			<label kind="synchronisation" x="-238" y="-85">receive_all?</label>
		</transition>
		<transition id="id57">
			<source ref="id50"/>
			<target ref="id47"/>
			<label kind="synchronisation" x="51" y="-179">initialize?</label>
		</transition>
	</template>
	<template>
		<name x="5" y="5">station</name>
		<parameter>const station_id_t id, const int[0, 32768] processingTime</parameter>
		<declaration>clock x;</declaration>
		<location id="id58" x="-501" y="-374">
			<name x="-511" y="-408">Free</name>
		</location>
		<location id="id59" x="-280" y="-374">
			<name x="-290" y="-408">Busy</name>
			<label kind="invariant" x="-290" y="-357">x &lt;= processingTime</label>
		</location>
		<location id="id60" x="-391" y="-212">
			<name x="-401" y="-246">Done</name>
		</location>
		<init ref="id58"/>
		<transition id="id61">
			<source ref="id60"/>
			<target ref="id58"/>
			<label kind="comments" x="-483" y="-268">TODO: get message from next conveyor belt in order to release the token</label>
		</transition>
		<transition id="id62">
			<source ref="id59"/>
			<target ref="id60"/>
			<label kind="guard" x="-364" y="-327">x &gt;= processingTime</label>
			<label kind="synchronisation" x="-364" y="-310">stationOutput[id]!</label>
		</transition>
		<transition id="id63">
			<source ref="id58"/>
			<target ref="id59"/>
			<label kind="synchronisation" x="-483" y="-391">stationInput[id]?</label>
			<label kind="assignment" x="-483" y="-374">x = 0</label>
		</transition>
	</template>
	<template>
		<name x="5" y="5">flow_controller</name>
		<parameter>int policy, int T</parameter>
		<declaration>// Place local declarations here.
</declaration>
		<location id="id64" x="-1377" y="-680">
			<name x="-1428" y="-706">Open</name>
			<label kind="invariant" x="-1504" y="-722">queue_5_full != 0</label>
		</location>
		<location id="id65" x="-1181" y="-680">
			<name x="-1164" y="-706">Closed</name>
			<label kind="invariant" x="-1191" y="-663">queue_4_full != 0</label>
		</location>
		<location id="id66" x="-1360" y="-255">
			<name x="-1411" y="-247">Open</name>
		</location>
		<location id="id67" x="-1377" y="-68">
			<name x="-1360" y="-94">Closed</name>
		</location>
		<location id="id68" x="-1376" y="-442">
			<name x="-1427" y="-468">Open</name>
		</location>
		<location id="id69" x="-1181" y="-442">
			<name x="-1164" y="-468">Closed</name>
		</location>
		<location id="id70" x="-1733" y="-450">
			<label kind="invariant" x="-1743" y="-433">x&lt;1</label>
		</location>
		<location id="id71" x="-1376" y="85">
			<name x="-1393" y="42">Open</name>
			<label kind="invariant" x="-1402" y="119">x&lt;2*T</label>
		</location>
		<location id="id72" x="-1181" y="85">
			<name x="-1164" y="59">Closed</name>
			<label kind="invariant" x="-1191" y="102">x&lt;2*T</label>
		</location>
		<init ref="id70"/>
		<transition id="id73">
			<source ref="id70"/>
			<target ref="id67"/>
			<label kind="guard" x="-1530" y="-263">policy==3</label>
		</transition>
		<transition id="id74">
			<source ref="id70"/>
			<target ref="id71"/>
			<label kind="guard" x="-1530" y="8">policy==4</label>
		</transition>
		<transition id="id75">
			<source ref="id70"/>
			<target ref="id66"/>
			<label kind="guard" x="-1521" y="-374">policy==2</label>
		</transition>
		<transition id="id76">
			<source ref="id70"/>
			<target ref="id68"/>
			<label kind="guard" x="-1648" y="-476">policy==1</label>
		</transition>
		<transition id="id77">
			<source ref="id70"/>
			<target ref="id64"/>
			<label kind="guard" x="-1648" y="-595">policy==0</label>
		</transition>
		<transition id="id78">
			<source ref="id64"/>
			<target ref="id65"/>
			<nail x="-1334" y="-731"/>
			<nail x="-1275" y="-740"/>
			<nail x="-1215" y="-723"/>
		</transition>
		<transition id="id79">
			<source ref="id65"/>
			<target ref="id64"/>
			<nail x="-1224" y="-621"/>
			<nail x="-1275" y="-604"/>
			<nail x="-1326" y="-621"/>
		</transition>
		<transition id="id80">
			<source ref="id68"/>
			<target ref="id69"/>
			<label kind="synchronisation" x="-1334" y="-527">full_darkred_5!</label>
			<nail x="-1333" y="-493"/>
			<nail x="-1274" y="-502"/>
			<nail x="-1214" y="-485"/>
		</transition>
		<transition id="id81">
			<source ref="id69"/>
			<target ref="id68"/>
			<label kind="synchronisation" x="-1334" y="-357">full_darkred_3!</label>
			<nail x="-1223" y="-383"/>
			<nail x="-1274" y="-366"/>
			<nail x="-1325" y="-383"/>
		</transition>
		<transition id="id82">
			<source ref="id71"/>
			<target ref="id72"/>
			<label kind="guard" x="-1291" y="-17">x&gt;T</label>
			<label kind="assignment" x="-1291" y="0">x:=0</label>
			<nail x="-1333" y="34"/>
			<nail x="-1274" y="25"/>
			<nail x="-1214" y="42"/>
		</transition>
		<transition id="id83">
			<source ref="id72"/>
			<target ref="id71"/>
			<label kind="guard" x="-1291" y="161">x&gt;T</label>
			<label kind="assignment" x="-1291" y="178">x:=0</label>
			<nail x="-1223" y="144"/>
			<nail x="-1274" y="161"/>
			<nail x="-1325" y="144"/>
		</transition>
	</template>
	<system>system station;</system>
	<queries>
		<query>
			<formula/>
			<comment/>
		</query>
	</queries>
</nta>
